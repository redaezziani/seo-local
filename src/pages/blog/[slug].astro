---
import { sanityClient } from 'sanity:client';
import imageUrlBuilder from '@sanity/image-url';
import Main from '@/layouts/main.astro';
import NavBar from '@/components/react/nav-bar';
import Footer from '@/components/ui/footer.astro';

// Generate static paths for all blog posts
export async function getStaticPaths() {
  const posts = await sanityClient.fetch(
    `*[_type == "post"]{
      "slug": slug.current
    }`,
  );

  return posts.map((post: any) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;

// Fetch the current post
const post = await sanityClient.fetch(
  `*[_type == "post" && slug.current == $slug][0]{
    _id,
    title,
    slug,
    excerpt,
    mainImage{
      asset,
      alt,
      caption
    },
    categories[]->{
      title,
      slug
    },
    content,
    publishedAt,
    featured,
    seo
  }`,
  { slug },
);

if (!post) {
  return Astro.redirect('/404');
}

// Fetch related posts (same categories, excluding current post)
const relatedPosts = await sanityClient.fetch(
  `*[_type == "post" && _id != $postId && count((categories[]._ref)[@ in $categoryIds]) > 0] | order(publishedAt desc)[0...3]{
    _id,
    title,
    slug,
    excerpt,
    mainImage{
      asset,
      alt
    },
    publishedAt
  }`,
  {
    postId: post._id,
    categoryIds: post.categories?.map((c: any) => c._id) || [],
  },
);

const builder = imageUrlBuilder(sanityClient);
const urlFor = (source: any) => builder.image(source);

const getLocalizedText = (array: any[], lang = 'en') => {
  return array?.find((item) => item._key === lang)?.value || '';
};

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};

// Helper to render portable text blocks
const renderPortableText = (blocks: any[], lang = 'en') => {
  if (!blocks) return '';

  const localizedBlocks =
    blocks.find((b: any) => b._key === lang)?.value || blocks;

  return localizedBlocks
    .map((block: any) => {
      if (block._type === 'block') {
        const style = block.style || 'normal';
        const children = block.children
          ?.map((child: any) => {
            let text = child.text || '';
            if (child.marks?.includes('strong'))
              text = `<strong>${text}</strong>`;
            if (child.marks?.includes('em')) text = `<em>${text}</em>`;

            // Handle link annotations
            const linkMark = child.marks?.find((m: string) =>
              block.markDefs?.find(
                (def: any) => def._key === m && def._type === 'link',
              ),
            );
            if (linkMark) {
              const link = block.markDefs.find(
                (def: any) => def._key === linkMark,
              );
              text = `<a href="${link.href}" class="text-blue-500 hover:underline" target="_blank" rel="noopener">${text}</a>`;
            }

            return text;
          })
          .join('');

        const tagMap: Record<string, string> = {
          h1: 'h1',
          h2: 'h2',
          h3: 'h3',
          h4: 'h4',
          blockquote: 'blockquote',
          normal: 'p',
        };

        const tag = tagMap[style] || 'p';
        const classes: Record<string, string> = {
          h1: 'text-4xl font-bold mt-8 mb-4',
          h2: 'text-3xl font-bold mt-8 mb-4',
          h3: 'text-2xl font-bold mt-6 mb-3',
          h4: 'text-xl font-bold mt-6 mb-3',
          blockquote:
            'border-l-4 border-blue-500 pl-4 italic my-4 text-gray-700',
          normal: 'mb-4 leading-relaxed',
        };

        if (block.listItem) {
          return `<li class="mb-2">${children}</li>`;
        }

        return `<${tag} class="${classes[style] || ''}">${children}</${tag}>`;
      }
      return '';
    })
    .join('');
};

const metaTitle = post.seo?.metaTitle
  ? getLocalizedText(post.seo.metaTitle)
  : getLocalizedText(post.title);
const metaDescription = post.seo?.metaDescription
  ? getLocalizedText(post.seo.metaDescription)
  : getLocalizedText(post.excerpt);
---

<Main content={{ title: metaTitle }}>
  <NavBar />

  <!-- Article Header -->
  <article class="w-full mt-16">
    <!-- Featured Image -->
    {
      post.mainImage?.asset && (
        <div class="w-full h-[60vh] relative overflow-hidden">
          <img
            src={urlFor(post.mainImage.asset).width(1920).url()}
            alt={post.mainImage.alt || getLocalizedText(post.title)}
            class="w-full h-full object-cover"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent" />
        </div>
      )
    }

    <!-- Article Content -->
    <div class="max-w-4xl mx-auto px-4 -mt-32 relative z-10">
      <!-- Header Card -->
      <div class="bg-white rounded-xl shadow-lg p-8 md:p-12 mb-8">
        <!-- Categories & Date -->
        <div class="flex flex-wrap items-center gap-3 mb-4">
          {
            post.categories?.map((category: any) => (
              <a
                href={`/blog?category=${category.slug.current}`}
                class="text-xs font-medium text-blue-500 bg-blue-50 px-3 py-1 rounded-full hover:bg-blue-100 transition-colors"
              >
                {getLocalizedText(category.title)}
              </a>
            ))
          }
          <span class="text-sm text-gray-500">
            {formatDate(post.publishedAt)}
          </span>
        </div>

        <!-- Title -->
        <h1 class="text-4xl md:text-5xl font-bold text-zinc-900 mb-4">
          {getLocalizedText(post.title)}
        </h1>

        <!-- Excerpt -->
        {
          post.excerpt && (
            <p class="text-xl text-gray-600 leading-relaxed">
              {getLocalizedText(post.excerpt)}
            </p>
          )
        }
      </div>

      <!-- Article Body -->
      <div class="bg-white rounded-xl shadow-lg p-8 md:p-12 mb-8">
        <div
          class="prose prose-lg max-w-none"
          set:html={renderPortableText(post.content)}
        />
      </div>

      <!-- Share Buttons -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h3 class="text-lg font-semibold mb-4">Share this article</h3>
        <div class="flex gap-3">
          <button
            class="share-btn flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            data-platform="twitter"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"
              ></path>
            </svg>
            Twitter
          </button>
          <button
            class="share-btn flex items-center gap-2 px-4 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-900 transition-colors"
            data-platform="facebook"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"
              ></path>
            </svg>
            Facebook
          </button>
          <button
            class="share-btn flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
            data-platform="linkedin"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
              ></path>
            </svg>
            LinkedIn
          </button>
        </div>
      </div>

      <!-- Related Posts -->
      {
        relatedPosts.length > 0 && (
          <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <h3 class="text-2xl font-bold mb-6">Related Articles</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              {relatedPosts.map((relatedPost: any) => (
                <a href={`/blog/${relatedPost.slug.current}`} class="group">
                  {relatedPost.mainImage?.asset && (
                    <div class="relative overflow-hidden rounded-lg mb-3 h-40">
                      <img
                        src={urlFor(relatedPost.mainImage.asset)
                          .width(400)
                          .url()}
                        alt={
                          relatedPost.mainImage.alt ||
                          getLocalizedText(relatedPost.title)
                        }
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      />
                    </div>
                  )}
                  <h4 class="font-semibold text-zinc-900 group-hover:text-blue-500 transition-colors mb-2">
                    {getLocalizedText(relatedPost.title)}
                  </h4>
                  <p class="text-sm text-gray-500">
                    {formatDate(relatedPost.publishedAt)}
                  </p>
                </a>
              ))}
            </div>
          </div>
        )
      }

      <!-- Back to Blog -->
      <div class="text-center mb-16">
        <a
          href="/blog"
          class="inline-flex items-center gap-2 text-blue-500 hover:text-blue-500 font-medium"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M19 12H5"></path>
            <path d="m12 19-7-7 7-7"></path>
          </svg>
          Back to Blog
        </a>
      </div>
    </div>
  </article>

  <Footer />
</Main>

<script>
  // Share functionality
  const shareButtons = document.querySelectorAll('.share-btn');
  const pageUrl = window.location.href;
  const pageTitle = document.title;

  shareButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const platform = button.getAttribute('data-platform');
      let shareUrl = '';

      switch (platform) {
        case 'twitter':
          shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(pageUrl)}&text=${encodeURIComponent(pageTitle)}`;
          break;
        case 'facebook':
          shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}`;
          break;
        case 'linkedin':
          shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(pageUrl)}`;
          break;
      }

      if (shareUrl) {
        window.open(shareUrl, '_blank', 'width=600,height=400');
      }
    });
  });
</script>
